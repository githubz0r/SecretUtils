---
title: "transmute_code_eps_2"
author: "githubz0r"
date: "2019-04-29"
output: workflowr::wflow_html
---

```{r}
#editor_options:
  #chunk_output_type: inline
```


load packages and data
```{r}
library(conos)
library(parallel)
library(ggplot2)
library(Matrix)
library(data.table)
library(pagoda2)
library(cowplot)
library(dplyr)
library(abind)
library(tidyr)
require(Rtsne)
source('/home/larsc/SecretUtils/R/asdf.R')
source('/home/larsc/SecretUtils/R/peter_code_utils.R')

con <- readRDS(file.path('/home/larsc/data/10x_preproced_graphed.rds'))
con <- Conos$new(con)
annot <- readRDS(file.path('/home/demharters/R/projects/UPF9_14_17_19_22_23_24_32_33/metadata_10x_final.rds'))
fraction_palette_eps <- c(epilepsy='hotpink', healthy='seagreen') 

```

'Fractional' changes.
```{r}
FractionalPlot(annot$sample, annot$subtype, annot$condition, fraction.palette = fraction_palette_eps)
```

Distance matrix tsne plot
```{r}
annot2 <- annot %>% mutate(cellid=rownames(annot))
source('/home/larsc/SecretUtils/R/peter_code_utils.R')
sub_dist_mat <- Makesubdistmat(con, annot2$sample, annot2$subtype, annot2$cellid)

## some weird shit
#testannot <- bind_cols(list(annot2$sample, annot2$subtype, annot2$cellid))
#tf_test <- setNames(testannot[, 2], testannot[, 3]) %>% as.factor # does not work
#tf_test <- setNames(testannot[[2]], testannot[[3]]) %>% as.factor
## end weird shit
PlotDistanceMatRed(sub_dist_mat, annot2$sample, annot2$subtype, annot2$sample, 
                   annot2$cellid, annot2$condition, perplexity=2, max_iter=1e4) # add labels
```

Condition distance distribution
```{r}
ConditionDistanceDensity(sub_dist_mat, annot$sample, annot$subtype, annot$sample, annot2$cellid, annot$condition,
                         notch=TRUE, fraction.palette = fraction_palette_eps)

```




Distribution distances per cell type (using ctdm so must be unweighted)
```{r}
min_cells=0
PlotCellTypeDists(sub_dist_mat, min_cells)
```

